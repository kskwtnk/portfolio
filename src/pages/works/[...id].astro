---
import type {
  GetStaticPaths,
  InferGetStaticPropsType,
  MarkdownHeading,
} from "astro";
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";
import ExceptTopLayout from "../../layouts/ExceptTopLayout.astro";
import "../../styles/markdown.css";

export const getStaticPaths = (async () => {
  const workEntries = await getCollection("works");
  return workEntries
    .sort((a, b) => b.data.startDate.getTime() - a.data.startDate.getTime())
    .map((entry, i) => ({
      params: { id: entry.id },
      props: { entry, prev: workEntries[i - 1], next: workEntries[i + 1] },
    }));
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { entry, prev, next } = Astro.props;
const { Content, headings } = await render(entry);
const startDate = new Intl.DateTimeFormat("ja-JP", {
  year: "numeric",
  month: "numeric",
  timeZone: "Asia/Tokyo",
}).format(entry.data.startDate);
const endDate = entry.data.endDate
  ? new Intl.DateTimeFormat("ja-JP", {
      year: "numeric",
      month: "numeric",
      timeZone: "Asia/Tokyo",
    }).format(entry.data.endDate)
  : "";

function buildToc(headings: MarkdownHeading[]) {
  const toc: {
    subheadings: never[];
    depth: number;
    slug: string;
    text: string;
  }[] = [];
  const parentHeadings = new Map();
  for (const h of headings) {
    const heading = { ...h, subheadings: [] };
    parentHeadings.set(heading.depth, heading);
    if (heading.depth === 2) {
      toc.push(heading);
    } else {
      parentHeadings.get(heading.depth - 1).subheadings.push(heading);
    }
  }
  return toc;
}

const toc = buildToc(headings);
---

<ExceptTopLayout title={entry.data.title} excerpt={entry.data.excerpt}>
  <div class="mx-auto grid max-w-5xl grid-cols-3 gap-x-6 gap-y-8 pb-12">
    <div
      class="col-span-full grid grid-cols-subgrid gap-y-5 md:row-start-1 md:row-end-2"
    >
      <h1 class="col-span-full text-4xl font-bold sm:text-5xl md:text-7xl">
        {entry.data.title}
      </h1>
      <dl class="col-span-full grid grid-cols-subgrid items-start gap-y-3">
        <div
          class="col-span-full border-l-2 border-zinc-300 pl-2 md:col-start-1 md:col-end-2"
        >
          <dt class="text-xs">制作期間</dt>
          <dd class="text-sm md:text-lg">
            {`${startDate} – ${endDate}`}
          </dd>
        </div>
        <div
          class="col-span-full border-l-2 border-zinc-300 pl-2 md:col-start-2 md:col-end-4"
        >
          <dt class="text-xs">概要</dt>
          <dd class="text-sm md:text-lg">
            {entry.data.excerpt}
          </dd>
        </div>
      </dl>
    </div>
    <Image
      src={entry.data.cover}
      alt=""
      class="col-span-full mx-[calc(50%-50cqi)] w-[100cqi] max-w-none md:mx-[calc(var(--spacing)*8*-1)] md:w-[calc(100%+var(--spacing)*8*2)]"
      transition:name={`${entry.id}Image`}
    />
    <div
      class="top-16 col-span-full border-l-2 border-zinc-300 pl-2 md:sticky md:col-start-1 md:col-end-2 md:row-start-3 md:row-end-4"
    >
      <span class="text-xs">目次</span>
      <ul class="mt-1 flex flex-col gap-1 text-sm">
        {
          toc.map((heading) => (
            <li>
              <a href={`#${heading.slug}`}>{heading.text}</a>
            </li>
          ))
        }
      </ul>
    </div>
    <div
      id="content"
      class="text-md col-span-full md:col-start-2 md:col-end-4 md:row-start-3 md:row-end-6"
    >
      <Content />
    </div>
    <div
      class="text-md col-span-full flex flex-col gap-y-1 md:col-start-2 md:col-end-4"
    >
      {
        prev && (
          <span>
            前の記事:
            <a
              href={`/works/${prev.id}`}
              class="text-cyan-600 underline hover:text-cyan-900"
            >
              {prev.data.title}
            </a>
          </span>
        )
      }
      {
        next && (
          <span>
            次の記事:
            <a
              href={`/works/${next.id}`}
              class="text-cyan-600 underline hover:text-cyan-900"
            >
              {next.data.title}
            </a>
          </span>
        )
      }
    </div>
  </div>
</ExceptTopLayout>
